<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tzg.entitys.auditinformation.AuditinformationMapper">
	<resultMap id="BaseResultMap" type="com.tzg.entitys.auditinformation.Auditinformation">
		<id column="id" property="id" jdbcType="INTEGER" />
	    <result column="iSourceD" property="iSourceD" jdbcType="INTEGER" />
	    <result column="vcApproveLevel" property="vcApproveLevel" jdbcType="VARCHAR" />
	    <result column="vcApprovalName" property="vcApprovalName" jdbcType="VARCHAR" />
	    <result column="vcApproverName" property="vcApproverName" jdbcType="VARCHAR" />
	    <result column="dtApprove" property="dtApprove" jdbcType="TIMESTAMP" />
	    <result column="iState" property="iState" jdbcType="INTEGER" />
	    <result column="vcApproveIdea" property="vcApproveIdea" jdbcType="VARCHAR" />
	    <result column="dtCreate" property="dtCreate" jdbcType="TIMESTAMP" />
	    <result column="iType" property="iType" jdbcType="INTEGER" />
	</resultMap>
	
	<sql id="columns">
	    <![CDATA[
        id ,iSourceD ,vcApproveLevel ,vcApproverName ,dtApprove ,iState ,vcApproveIdea ,dtCreate ,iType 
	    ]]>
	</sql>
	
	<insert id="save" parameterType="com.tzg.entitys.auditinformation.Auditinformation" >
		<selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="id">
            SELECT LAST_INSERT_ID() AS id
        </selectKey>
	    insert into tbauditinformation (iSourceD, vcApproveLevel, 
	      vcApproverName, dtApprove, iState, 
	      vcApproveIdea, dtCreate, iType
	      )
	    values (
	            #{iSourceD,jdbcType=INTEGER}, 
	            #{vcApproveLevel,jdbcType=VARCHAR}, 
		        #{vcApproverName,jdbcType=VARCHAR},
		        #{dtApprove,jdbcType=TIMESTAMP}, 
		        #{iState,jdbcType=INTEGER}, 
		        #{vcApproveIdea,jdbcType=VARCHAR}, 
		        #{dtCreate,jdbcType=TIMESTAMP}, 
		        #{iType,jdbcType=INTEGER}
	      )
  </insert>


	<update id="update" parameterType="com.tzg.entitys.auditinformation.Auditinformation" >
    update tbauditinformation
    <set >
      <if test="iSourceD != null" >
        iSourceD = #{iSourceD,jdbcType=INTEGER},
      </if>
      <if test="vcApproveLevel != null" >
        vcApproveLevel = #{vcApproveLevel,jdbcType=VARCHAR},
      </if>
      <if test="vcApproverName != null" >
        vcApproverName = #{vcApproverName,jdbcType=VARCHAR},
      </if>
      <if test="dtApprove != null" >
        dtApprove = #{dtApprove,jdbcType=TIMESTAMP},
      </if>
      <if test="iState != null" >
        iState = #{iState,jdbcType=INTEGER},
      </if>
      <if test="vcApproveIdea != null" >
        vcApproveIdea = #{vcApproveIdea,jdbcType=VARCHAR},
      </if>
      <if test="dtCreate != null" >
        dtCreate = #{dtCreate,jdbcType=TIMESTAMP},
      </if>
      <if test="iType != null" >
        iType = #{iType,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>


	<select id="findById" resultMap="BaseResultMap" parameterType="java.lang.Integer">
	    SELECT <include refid="columns"/> 
	<![CDATA[
		FROM tbauditinformation 
		WHERE 
        id = #{id} 
	]]>
	</select>
    
    <!-- 根据iSourceD，查询最近一次的审核等级 -->
    <select id="queryRecentAuditLevel" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    	select * from tbauditinformation a
    	where a.iSourceD = #{iSourceD,jdbcType=INTEGER}
    	ORDER BY a.id DESC 
    	LIMIT 1
    </select>
    
    
    <select id="findPageCount" resultType="java.lang.Integer" parameterType="java.util.Map">
    	select count(*) from tbauditinformation a,tbapprovalrating r where a.vcApproveLevel=r.id
		<include refid="queryWhere"/>
	</select>
    
	<select id="findPage" resultMap="BaseResultMap" parameterType="java.util.Map">
		select a.id ,a.iSourceD ,a.vcApproveLevel ,a.vcApproverName ,a.dtApprove ,a.iState ,a.vcApproveIdea ,a.dtCreate ,a.iType,r.vcApprovalName 
		  from tbauditinformation a,tbapprovalrating r where a.vcApproveLevel=r.id
		<include refid="queryWhere"/>
	    <![CDATA[ ORDER BY dtApprove asc ]]>
        <![CDATA[ LIMIT ${startRecord},${endRecord} ]]>
	</select>
    
    <sql id="queryWhere">
		<if test="iSourceD != null">
		and iSourceD = #{iSourceD}
		</if>
		<if test="vcApproveLevel != null">
		and vcApproveLevel = #{vcApproveLevel}
		</if>
		<if test="vcApproverName != null">
		and vcApproverName = #{vcApproverName}
		</if>
		<if test="dtApproveBegin != null and dtApproveBegin != ''">
		and dtApprove >= #{dtApproveBegin}
		</if>
		<if test="dtApproveEnd != null and dtApproveEnd != ''">
		and dtApprove &lt;= #{dtApproveEnd}
		</if>
		<if test="iState != null">
		and iState = #{iState}
		</if>
		<if test="iType != null">
		and iType = #{iType}
		</if>
	</sql>
    


</mapper>
