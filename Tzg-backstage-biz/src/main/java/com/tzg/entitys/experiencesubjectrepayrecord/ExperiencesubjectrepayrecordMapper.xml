<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tzg.entitys.experiencesubjectrepayrecord.ExperiencesubjectrepayrecordMapper">	
	<resultMap id="BaseResultMap" type="com.tzg.entitys.experiencesubjectrepayrecord.Experiencesubjectrepayrecord">
		<result property="id" jdbcType="INTEGER" column="ID"/>
		<result property="iloginAccountId" jdbcType="INTEGER" column="iLoginAccountID"/>
		<result property="isubjectId" jdbcType="INTEGER" column="iSubjectID"/>
		<result property="iinvestRecordId" jdbcType="INTEGER" column="iInvestRecordID"/>
		<result property="itype" jdbcType="INTEGER" column="iType"/>
		<result property="numRepayInterest" jdbcType="DECIMAL" column="numRepayInterest"/>
		<result property="dtRepay" jdbcType="DATE" column="dtRepay"/>
		<result property="dtActualRepay" jdbcType="TIMESTAMP" column="dtActualRepay"/>
		<result property="istate" jdbcType="INTEGER" column="iState"/>
		<result property="dtCreate" jdbcType="TIMESTAMP" column="dtCreate"/>
    </resultMap>
	
	<sql id="columns">
	    <![CDATA[
        ID ,iLoginAccountID ,iSubjectID ,iInvestRecordID ,iType ,numRepayInterest ,dtRepay ,dtActualRepay ,iState ,dtCreate 
	    ]]>
	</sql>
	
	<insert id="save" parameterType="com.tzg.entitys.experiencesubjectrepayrecord.Experiencesubjectrepayrecord" useGeneratedKeys="true" keyProperty="id">
		<selectKey resultType="java.lang.Integer" keyProperty="id" order="AFTER" >
	      SELECT LAST_INSERT_ID() AS id
	    </selectKey>
	<![CDATA[
		INSERT INTO tbexperiencesubjectrepayrecord (
        	iLoginAccountID ,
        	iSubjectID ,
        	iInvestRecordID ,
        	iType ,
        	numRepayInterest ,
        	dtRepay ,
        	dtActualRepay ,
        	iState ,
        	dtCreate 
		) VALUES (
        	#{iloginAccountId,jdbcType=INTEGER} ,
        	#{isubjectId,jdbcType=INTEGER} ,
        	#{iinvestRecordId,jdbcType=INTEGER} ,
        	#{itype,jdbcType=INTEGER} ,
        	#{numRepayInterest,jdbcType=DECIMAL} ,
        	#{dtRepay,jdbcType=DATE} ,
        	#{dtActualRepay,jdbcType=TIMESTAMP} ,
        	#{istate,jdbcType=INTEGER} ,
        	#{dtCreate,jdbcType=TIMESTAMP} 
		)
	]]>
	</insert>

	<update id="update" parameterType="com.tzg.entitys.experiencesubjectrepayrecord.Experiencesubjectrepayrecord">
		UPDATE tbexperiencesubjectrepayrecord
		<set>
			<if test="iloginAccountId != null">
	        iLoginAccountID = #{iloginAccountId,jdbcType=INTEGER} ,
	        </if>
			<if test="isubjectId != null">
	        iSubjectID = #{isubjectId,jdbcType=INTEGER} ,
	        </if>
			<if test="iinvestRecordId != null">
	        iInvestRecordID = #{iinvestRecordId,jdbcType=INTEGER} ,
	        </if>
			<if test="itype != null">
	        iType = #{itype,jdbcType=INTEGER} ,
	        </if>
			<if test="numRepayInterest != null">
	        numRepayInterest = #{numRepayInterest,jdbcType=DECIMAL} ,
	        </if>
			<if test="dtRepay != null">
	        dtRepay = #{dtRepay,jdbcType=DATE} ,
	        </if>
			<if test="dtActualRepay != null">
	        dtActualRepay = #{dtActualRepay,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="istate != null">
	        iState = #{istate,jdbcType=INTEGER} ,
	        </if>
			<if test="dtCreate != null">
	        dtCreate = #{dtCreate,jdbcType=TIMESTAMP} 
	        </if>
	    </set>
		WHERE 
	        ID = #{id,jdbcType=INTEGER} 
	</update>

	<delete id="deleteById" parameterType="java.lang.Integer">
	<![CDATA[
		DELETE FROM tbexperiencesubjectrepayrecord WHERE
        ID = #{id} 
	]]>
	</delete>
    
	<select id="findById" resultMap="BaseResultMap" parameterType="java.lang.Integer">
	    SELECT <include refid="columns"/> 
	<![CDATA[
		FROM tbexperiencesubjectrepayrecord 
		WHERE 
        ID = #{id} 
	]]>
	</select>
	<select id="findPageCount" resultType="java.lang.Integer" parameterType="java.util.Map">
    	select count(*) from  tbexperiencesubjectrepayrecord rr,tbExperienceSubject s where rr.iSubjectID = s.id
		<include refid="queryWhere4Page"/>
	</select>
	
	<resultMap id="pageResultMap" extends="BaseResultMap"  type="com.tzg.entitys.experiencesubjectrepayrecord.Experiencesubjectrepayrecord">
		<result property="vcSubjectName" jdbcType="VARCHAR" column="vcName"/>
	</resultMap>
	<select id="findPage" resultMap="pageResultMap" parameterType="java.util.Map">
		select rr.ID ,rr.iLoginAccountID ,rr.iSubjectID ,rr.iInvestRecordID ,rr.iType ,rr.numRepayInterest ,rr.dtRepay ,rr.dtActualRepay ,rr.iState ,rr.dtCreate,s.vcName  
		from tbexperiencesubjectrepayrecord rr,tbExperienceSubject s where rr.iSubjectID = s.id
		<include refid="queryWhere4Page"/>
		<choose>
	            <when test="sortField != null and sortField != ''">
	               ORDER BY rr.dtRepay <choose> <when test="sortField != 'dtActualRepay'"> asc </when> <otherwise> desc</otherwise></choose>,
	               rr.iSubjectID asc,
	               dtActualRepay <choose> <when test="sortField != 'dtActualRepay'"> asc </when> <otherwise> desc</otherwise></choose>  
	            </when>
	            <otherwise>
	                 ORDER BY rr.dtRepay ASC,rr.id ASC
	            </otherwise>
	        </choose> 
        <![CDATA[ LIMIT ${startRecord},${endRecord} ]]>
	</select>
	
	<sql id="queryWhere4Page">
		<if test="id != null and id.trim() != ''">
		and rr.ID = #{id}
		</if>
		<if test="iloginAccountId != null and iloginAccountId.trim() != ''">
		and rr.iLoginAccountID = #{iloginAccountId}
		</if>
		<if test="isubjectId != null and isubjectId.trim() != ''">
		and rr.iSubjectID = #{isubjectId}
		</if>
		<if test="iinvestRecordId != null and iinvestRecordId.trim() != ''">
		and rr.iInvestRecordID = #{iinvestRecordId}
		</if>
		<if test="itype != null and itype.trim() != ''">
		and rr.iType = #{itype}
		</if>
		<if test="numRepayInterest != null and numRepayInterest.trim() != ''">
		and rr.numRepayInterest = #{numRepayInterest}
		</if>
		<if test="dtRepayBegin != null and dtRepayBegin.trim() != ''">
		and rr.dtRepay >= #{dtRepayBegin}
		</if>
		<if test="dtRepayEnd != null and dtRepayEnd.trim() != ''">
		and rr.dtRepay &lt;= #{dtRepayEnd}
		</if>
		<if test="dtActualRepayBegin != null and dtActualRepayBegin.trim() != ''">
		and rr.dtActualRepay >= #{dtActualRepayBegin}
		</if>
		<if test="dtActualRepayEnd != null and dtActualRepayEnd.trim() != ''">
		and rr.dtActualRepay &lt;= #{dtActualRepayEnd}
		</if>
		<if test="istate != null and istate.trim() != ''">
		and rr.iState = #{istate}
		</if>
		<if test="dtCreateBegin != null and dtCreateBegin.trim() != ''">
		and rr.dtCreate >= #{dtCreateBegin}
		</if>
		<if test="dtCreateEnd != null and dtCreateEnd.trim() != ''">
		and rr.dtCreate &lt;= #{dtCreateEnd}
		</if>
	</sql>
	
	<sql id="queryWhere">
		<if test="id != null and id.trim() != ''">
		and ID = #{id}
		</if>
		<if test="iloginAccountId != null and iloginAccountId.trim() != ''">
		and iLoginAccountID = #{iloginAccountId}
		</if>
		<if test="isubjectId != null and isubjectId.trim() != ''">
		and iSubjectID = #{isubjectId}
		</if>
		<if test="iinvestRecordId != null and iinvestRecordId.trim() != ''">
		and iInvestRecordID = #{iinvestRecordId}
		</if>
		<if test="itype != null and itype.trim() != ''">
		and iType = #{itype}
		</if>
		<if test="numRepayInterest != null and numRepayInterest.trim() != ''">
		and numRepayInterest = #{numRepayInterest}
		</if>
		<if test="dtRepayBegin != null and dtRepayBegin.trim() != ''">
		and dtRepay >= #{dtRepayBegin}
		</if>
		<if test="dtRepayEnd != null and dtRepayEnd.trim() != ''">
		and dtRepay &lt;= #{dtRepayEnd}
		</if>
		<if test="dtActualRepayBegin != null and dtActualRepayBegin.trim() != ''">
		and dtActualRepay >= #{dtActualRepayBegin}
		</if>
		<if test="dtActualRepayEnd != null and dtActualRepayEnd.trim() != ''">
		and dtActualRepay &lt;= #{dtActualRepayEnd}
		</if>
		<if test="istate != null and istate.trim() != ''">
		and iState = #{istate}
		</if>
		<if test="dtCreateBegin != null and dtCreateBegin.trim() != ''">
		and dtCreate >= #{dtCreateBegin}
		</if>
		<if test="dtCreateEnd != null and dtCreateEnd.trim() != ''">
		and dtCreate &lt;= #{dtCreateEnd}
		</if>
	</sql>
	
	<resultMap id="InvestIncomeResultMap" type="com.tzg.entitys.experiencesubjectrepayrecord.InvestIncomeVO">
		<result property="interest" jdbcType="DECIMAL" column="interest"/>
		<result property="invest" jdbcType="DECIMAL" column="invest"/>
	</resultMap>
	<select id="statInvestIncome" resultMap="InvestIncomeResultMap" parameterType="java.util.Map">
    	select sum(irr.numRepayInterest) as interest, sum(ir.numInvest) as invest 
    	from tbexperiencesubjectrepayrecord irr,tbExperienceSubjectInvestRecord ir  where 1=1
    	and irr.iInvestRecordID=ir.id
		<if test="iloginAccountId != null and iloginAccountId.trim() != ''">
		and ir.iLoginAccountID = #{iloginAccountId}
		</if>
		<if test="andIstateIn != null and andIstateIn.trim() != ''">
		and ir.iState in (${andIstateIn})
		</if>
		<if test="repayState != null and repayState.trim() != ''">
		and irr.iState = #{repayState}
		</if>
	</select>
	
	<select id="findRepayNow" resultMap="BaseResultMap" parameterType="java.util.Map">
		select <include refid="columns"/>
		FROM
			tbexperiencesubjectrepayrecord esr
		WHERE
			esr.dtRepay &lt;= now()
		AND esr.iState = 1
	</select>
	
	<resultMap id="RepayStatResultMap" type="com.tzg.entitys.experiencesubjectrepayrecord.RepayStatVO">
		<result property="istate" jdbcType="INTEGER" column="iState"/>
		<result property="interest" jdbcType="DECIMAL" column="interest"/>
    </resultMap>
	<select id="statRepayByState"  resultMap="RepayStatResultMap" parameterType="java.util.Map">
		SELECT
			esrr.iState,
			sum(esrr.numRepayInterest) AS interest
		FROM
			tbexperiencesubjectrepayrecord esrr,tbExperienceSubject s 
		WHERE
			esrr.iSubjectID = s.id 
			and esrr.iLoginAccountID = #{iloginAccountId,jdbcType=INTEGER}
		GROUP BY
			esrr.iState
	</select>
</mapper>


