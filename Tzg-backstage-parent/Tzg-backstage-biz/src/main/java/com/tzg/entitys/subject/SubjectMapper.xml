<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tzg.entitys.subject.SubjectMapper">	
	<resultMap id="BaseResultMap" type="com.tzg.entitys.subject.Subject">
		<result property="id" jdbcType="INTEGER" column="id"/>
		<result property="iprojectId" jdbcType="INTEGER" column="iProjectID"/>
		<result property="iProjectCategyID" jdbcType="INTEGER" column="iProjectCategyID"/>
		<result property="projectName" jdbcType="VARCHAR" column="projectName"/>
		<result property="projectCode" jdbcType="VARCHAR" column="projectCode"/>
		<result property="projectType" jdbcType="VARCHAR" column="projectType"/>
		<result property="iguaranteeId" jdbcType="INTEGER" column="iGuaranteeID"/>
		<result property="borrowerType" jdbcType="INTEGER" column="iBorrowerType"/>		
		<result property="projectNumTotalFinancing" jdbcType="INTEGER" column="numTotalFinancing"/>	
		<result property="vcName" jdbcType="VARCHAR" column="vcName"/>
		<result property="vcShortDesp" jdbcType="VARCHAR" column="vcShortDesp"/>
		<result property="iloginAccountId" jdbcType="INTEGER" column="iLoginAccountID"/>
		<result property="numInterestRate" jdbcType="DECIMAL" column="numInterestRate"/>
		<result property="numRewardRate" jdbcType="DECIMAL" column="numRewardRate"/>
		<result property="numManagementRate" jdbcType="DECIMAL" column="numManagementRate"/>
		<result property="numTotalFinancing" jdbcType="DECIMAL" column="numTotalFinancing"/>
		<result property="ivalueDateType" jdbcType="INTEGER" column="iValueDateType"/>
		<result property="numDelivery" jdbcType="DECIMAL" column="numDelivery"/>
		<result property="numMinInvest" jdbcType="DECIMAL" column="numMinInvest"/>
		<result property="numMaxInvest" jdbcType="DECIMAL" column="numMaxInvest"/>
		<result property="numPlatFormFee" jdbcType="DECIMAL" column="numPlatFormFee"/>
		<result property="iplatFormFeeType" jdbcType="INTEGER" column="iPlatFormFeeType"/>
		<result property="numBond" jdbcType="DECIMAL" column="numBond"/>
		<result property="ibondType" jdbcType="INTEGER" column="iBondType"/>
		<result property="numPeriod" jdbcType="INTEGER" column="numPeriod"/>
		<result property="dtTrailer" jdbcType="TIMESTAMP" column="dtTrailer"/>
		<result property="dtCollectStart" jdbcType="TIMESTAMP" column="dtCollectStart"/>
		<result property="dtCollectEnd" jdbcType="TIMESTAMP" column="dtCollectEnd"/>
		<result property="dtActualCollectEnd" jdbcType="TIMESTAMP" column="dtActualCollectEnd"/>
		<result property="numActualFinancing" jdbcType="DECIMAL" column="numActualFinancing"/>
		<result property="numActualExtraInterest" jdbcType="DECIMAL" column="numActualExtraInterest"/>
		<result property="numActualInterest" jdbcType="DECIMAL" column="numActualInterest"/>
		<result property="istate" jdbcType="INTEGER" column="iState"/>
		<result property="dtRepayment" jdbcType="DATE" column="dtRepayment"/>
		<result property="icontractId" jdbcType="INTEGER" column="iContractID"/>
		<result property="numNextRepayAmount" jdbcType="DECIMAL" column="numNextRepayAmount"/>
		<result property="dtNextRepay" jdbcType="TIMESTAMP" column="dtNextRepay"/>
		<result property="dtCreate" jdbcType="TIMESTAMP" column="dtCreate"/>
		<result property="vcCurrentFlow" jdbcType="VARCHAR" column="vcCurrentFlow"/>
		<result property="vcApprovalFlow" jdbcType="VARCHAR" column="vcApprovalFlow"/>
		<result property="imode" jdbcType="INTEGER" column="iMode"/>
		<result property="irepayMode" jdbcType="INTEGER" column="iRepayMode"/>
		<result property="itype" jdbcType="INTEGER" column="iType"/>
		<result property="idisplayState" jdbcType="INTEGER" column="iDisplayState"/>
		<result property="numCurrentPeriod" jdbcType="INTEGER" column="numCurrentPeriod"/>
		<result property="numTotalPeriod" jdbcType="INTEGER" column="numTotalPeriod"/>	
		<result property="numDiscount" jdbcType="DECIMAL" column="numDiscount"/>
		<result property="vcAwardsDesp" jdbcType="VARCHAR" column="vcAwardsDesp"/>
		<result property="numWithdrawFee" jdbcType="DECIMAL" column="numWithdrawFee"/>
		<result property="iInterestConfigId" jdbcType="INTEGER" column="iInterestConfigID"/>
		<result property="iUseInterestTicket" jdbcType="INTEGER" column="iUseInterestTicket"/>
		<result property="iClassType" jdbcType="INTEGER" column="iClassType"/>

		<result property="iIsAutoOpenSubject" jdbcType="INTEGER" column="iIsAutoOpenSubject"/>
		<result property="iAutoOpenPriority" jdbcType="INTEGER" column="iAutoOpenPriority"/>
		<result property="iSubjectPeriodGradeID" jdbcType="INTEGER" column="iSubjectPeriodGradeID"/>
		<result property="iAutoOpenDay" jdbcType="INTEGER" column="iAutoOpenDay"/>
		
    </resultMap>
	
	<sql id="columns">
	    <![CDATA[
        id ,iProjectID ,iProjectCategyID,vcName ,vcShortDesp ,iLoginAccountID ,numInterestRate ,numRewardRate ,
        numManagementRate ,numTotalFinancing ,iValueDateType ,numDelivery ,
        numMinInvest ,numMaxInvest ,numPlatFormFee ,iPlatFormFeeType ,numBond ,
        iBondType ,numPeriod ,dtTrailer ,dtCollectStart ,dtCollectEnd ,
        dtActualCollectEnd ,numActualFinancing ,numActualExtraInterest ,
        numActualInterest ,iState ,dtRepayment ,iContractID ,numNextRepayAmount ,
        dtNextRepay ,dtCreate ,vcCurrentFlow ,vcApprovalFlow ,
        iMode ,iRepayMode  ,iType ,idisplayState,numCurrentPeriod,numTotalPeriod,
        numDiscount,vcAwardsDesp,numWithdrawFee,iInterestConfigID,iUseInterestTicket,iClassType ,iIsAutoOpenSubject,
        	iAutoOpenPriority,
        	iSubjectPeriodGradeID,iAutoOpenDay,
        	dtModify
	    ]]>
	</sql>
	<!-- linjie 查询期限等级列表 -->
	<select id="findSubGrade"  resultMap="BaseResultMap">
		select id,vcName from tbSubjectPeriodGrade where iState=1 order by iSort
	</select>
	
	<insert id="save" parameterType="com.tzg.entitys.subject.Subject" useGeneratedKeys="true" keyProperty="id">
		<selectKey resultType="java.lang.Integer" keyProperty="id" order="AFTER" >
	      SELECT LAST_INSERT_ID() AS id
	    </selectKey>
	<![CDATA[
		INSERT INTO tbsubject (
        	iProjectID ,
        	iProjectCategyID,
        	vcName ,
        	vcShortDesp ,
        	iLoginAccountID ,
        	numInterestRate ,
        	numRewardRate ,
        	numManagementRate ,
        	numTotalFinancing ,
        	iValueDateType ,
        	numDelivery ,
        	numMinInvest ,
        	numMaxInvest ,
        	numPlatFormFee ,
        	iPlatFormFeeType ,
        	numBond ,
        	iBondType ,
        	numPeriod ,
        	dtTrailer ,
        	dtCollectStart ,
        	dtCollectEnd ,
        	dtActualCollectEnd ,
        	numActualFinancing ,
        	numActualExtraInterest ,
        	numActualInterest ,
        	iState ,
        	dtRepayment ,
        	iContractID ,
        	numNextRepayAmount ,
        	dtNextRepay ,
        	dtCreate ,
        	vcCurrentFlow ,
        	vcApprovalFlow ,
        	iMode ,
        	iRepayMode  ,
        	iType ,
        	iDisplayState,
        	numCurrentPeriod,
        	numTotalPeriod,
        	numDiscount,
        	vcAwardsDesp,
        	numWithdrawFee,
        	iIsAutoOpenSubject,
        	iSubjectPeriodGradeID,
        	iAutoOpenDay,
        	iInterestConfigID,
        	iUseInterestTicket,
        	iClassType,
        	dtModify
		) VALUES (
        	#{iprojectId,jdbcType=INTEGER} ,
        	#{iProjectCategyID,jdbcType=INTEGER} ,
        	#{vcName,jdbcType=VARCHAR} ,
        	#{vcShortDesp,jdbcType=VARCHAR} ,
        	#{iloginAccountId,jdbcType=INTEGER} ,
        	#{numInterestRate,jdbcType=DECIMAL} ,
        	#{numRewardRate,jdbcType=DECIMAL} ,
        	#{numManagementRate,jdbcType=DECIMAL} ,
        	#{numTotalFinancing,jdbcType=DECIMAL} ,
        	#{ivalueDateType,jdbcType=INTEGER} ,
        	#{numDelivery,jdbcType=DECIMAL} ,
        	#{numMinInvest,jdbcType=DECIMAL} ,
        	#{numMaxInvest,jdbcType=DECIMAL} ,
        	#{numPlatFormFee,jdbcType=DECIMAL} ,
        	#{iplatFormFeeType,jdbcType=INTEGER} ,
        	#{numBond,jdbcType=DECIMAL} ,
        	#{ibondType,jdbcType=INTEGER} ,
        	#{numPeriod,jdbcType=INTEGER} ,
        	#{dtTrailer,jdbcType=TIMESTAMP} ,
        	#{dtCollectStart,jdbcType=TIMESTAMP} ,
        	#{dtCollectEnd,jdbcType=TIMESTAMP} ,
        	#{dtActualCollectEnd,jdbcType=TIMESTAMP} ,
        	#{numActualFinancing,jdbcType=DECIMAL} ,
        	#{numActualExtraInterest,jdbcType=DECIMAL} ,
        	#{numActualInterest,jdbcType=DECIMAL} ,
        	#{istate,jdbcType=INTEGER} ,
        	#{dtRepayment,jdbcType=DATE} ,
        	#{icontractId,jdbcType=INTEGER} ,
        	#{numNextRepayAmount,jdbcType=DECIMAL} ,
        	#{dtNextRepay,jdbcType=TIMESTAMP} ,
        	#{dtCreate,jdbcType=TIMESTAMP} ,
        	#{vcCurrentFlow,jdbcType=VARCHAR} ,
        	#{vcApprovalFlow,jdbcType=VARCHAR} ,
        	#{imode,jdbcType=INTEGER} ,
        	#{irepayMode,jdbcType=INTEGER} ,
        	#{itype,jdbcType=INTEGER} ,
        	#{idisplayState,jdbcType=INTEGER},
        	#{numCurrentPeriod,jdbcType=INTEGER},
        	#{numTotalPeriod,jdbcType=INTEGER}  ,
        	#{numDiscount,jdbcType=DECIMAL} ,   
        	#{vcAwardsDesp,jdbcType=VARCHAR},   
        	#{numWithdrawFee,jdbcType=DECIMAL},
        	#{iIsAutoOpenSubject,jdbcType=INTEGER},
        	#{iSubjectPeriodGradeID,jdbcType=INTEGER},
        	#{iAutoOpenDay,jdbcType=INTEGER},	
        	#{iInterestConfigId,jdbcType=INTEGER} ,
        	#{iUseInterestTicket,jdbcType=INTEGER},
        	#{iClassType,jdbcType=INTEGER},
        	now()
		)
	]]>
	</insert>

	<update id="update" parameterType="com.tzg.entitys.subject.Subject">
		UPDATE tbsubject
		<set>
			<if test="iprojectId != null">
	        iProjectID = #{iprojectId,jdbcType=INTEGER} ,
	        </if>
	        <if test="iProjectCategyID != null">
	        iProjectCategyID = #{iProjectCategyID,jdbcType=INTEGER} ,
	        </if>
			<if test="vcName != null">
	        vcName = #{vcName,jdbcType=VARCHAR} ,
	        </if>
	        <if test="vcShortDesp != null">
	        vcShortDesp = #{vcShortDesp,jdbcType=VARCHAR} ,
	        </if>
			<if test="iloginAccountId != null">
	        iLoginAccountID = #{iloginAccountId,jdbcType=INTEGER} ,
	        </if>
			<if test="numInterestRate != null">
	        numInterestRate = #{numInterestRate,jdbcType=DECIMAL} ,
	        </if>
	        <if test="numRewardRate != null">
	        numRewardRate = #{numRewardRate,jdbcType=DECIMAL} ,
	        </if>
			<if test="numManagementRate != null">
	        numManagementRate = #{numManagementRate,jdbcType=DECIMAL} ,
	        </if>
			<if test="numTotalFinancing != null">
	        numTotalFinancing = #{numTotalFinancing,jdbcType=DECIMAL} ,
	        </if>
			<if test="ivalueDateType != null">
	        iValueDateType = #{ivalueDateType,jdbcType=INTEGER} ,
	        </if>
			<if test="numDelivery != null">
	        numDelivery = #{numDelivery,jdbcType=DECIMAL} ,
	        </if>
			<if test="numMinInvest != null">
	        numMinInvest = #{numMinInvest,jdbcType=DECIMAL} ,
	        </if>
			<if test="numMaxInvest != null">
	        numMaxInvest = #{numMaxInvest,jdbcType=DECIMAL} ,
	        </if>
			<if test="numPlatFormFee != null">
	        numPlatFormFee = #{numPlatFormFee,jdbcType=DECIMAL} ,
	        </if>
			<if test="iplatFormFeeType != null">
	        iPlatFormFeeType = #{iplatFormFeeType,jdbcType=INTEGER} ,
	        </if>
			<if test="numBond != null">
	        numBond = #{numBond,jdbcType=DECIMAL} ,
	        </if>
			<if test="ibondType != null">
	        iBondType = #{ibondType,jdbcType=INTEGER} ,
	        </if>
			<if test="numPeriod != null">
	        numPeriod = #{numPeriod,jdbcType=INTEGER} ,
	        </if>
			<if test="dtTrailer != null">
	        dtTrailer = #{dtTrailer,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="dtCollectStart != null">
	        dtCollectStart = #{dtCollectStart,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="dtCollectEnd != null">
	        dtCollectEnd = #{dtCollectEnd,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="dtActualCollectEnd != null">
	        dtActualCollectEnd = #{dtActualCollectEnd,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="numActualFinancing != null">
	        numActualFinancing = #{numActualFinancing,jdbcType=DECIMAL} ,
	        </if>
			<if test="numActualExtraInterest != null">
	        numActualExtraInterest = #{numActualExtraInterest,jdbcType=DECIMAL} ,
	        </if>
			<if test="numActualInterest != null">
	        numActualInterest = #{numActualInterest,jdbcType=DECIMAL} ,
	        </if>
			<if test="istate != null">
	        iState = #{istate,jdbcType=INTEGER} ,
	        </if>
			<if test="dtRepayment != null">
	        dtRepayment = #{dtRepayment,jdbcType=DATE} ,
	        </if>
			<if test="icontractId != null">
	        iContractID = #{icontractId,jdbcType=INTEGER} ,
	        </if>
			<if test="numNextRepayAmount != null">
	        numNextRepayAmount = #{numNextRepayAmount,jdbcType=DECIMAL} ,
	        </if>
			<if test="dtNextRepay != null">
	        dtNextRepay = #{dtNextRepay,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="dtCreate != null">
	        dtCreate = #{dtCreate,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="vcCurrentFlow != null">
	        vcCurrentFlow = #{vcCurrentFlow,jdbcType=VARCHAR} ,
	        </if>
			<if test="vcApprovalFlow != null">
	        vcApprovalFlow = #{vcApprovalFlow,jdbcType=VARCHAR} ,
	        </if>
			<if test="imode != null">
	        iMode = #{imode,jdbcType=INTEGER} ,
	        </if>
			<if test="irepayMode != null">
	        iRepayMode = #{irepayMode,jdbcType=INTEGER} ,
	        </if>
	        <if test="itype != null">
	        iType = #{itype,jdbcType=INTEGER} ,
	        </if>
	        <if test="idisplayState !=null">
	        iDisplayState = #{idisplayState,jdbcType=INTEGER},
	        </if>
	        <if test="numCurrentPeriod !=null">
	        numCurrentPeriod = #{numCurrentPeriod,jdbcType=INTEGER},
	        </if>	   
	        <if test="numTotalPeriod !=null">
	        numTotalPeriod = #{numTotalPeriod,jdbcType=INTEGER},
	        </if>	         
	        <if test="numDiscount != null">
	        numDiscount = #{numDiscount,jdbcType=DECIMAL} ,
	        </if> 
	        <if test="vcAwardsDesp != null">
	        vcAwardsDesp = #{vcAwardsDesp,jdbcType=VARCHAR} ,
	        </if>
	        <if test="numWithdrawFee != null">
	        numWithdrawFee = #{numWithdrawFee,jdbcType=DECIMAL},
	        </if>
	        <if test="iSubjectPeriodGradeID != null">
	        iSubjectPeriodGradeID = #{iSubjectPeriodGradeID,jdbcType=INTEGER},
	        </if>
	        <if test="iAutoOpenDay != null">
	        iAutoOpenDay = #{iAutoOpenDay,jdbcType=INTEGER},
	        </if>
		<if test="iInterestConfigId != null">
	        iInterestConfigID = #{iInterestConfigId,jdbcType=INTEGER},
	        </if>
	        <if test="iUseInterestTicket != null">
	        iUseInterestTicket = #{iUseInterestTicket,jdbcType=INTEGER},
	        </if>
	        <if test="iClassType != null">
	        iClassType = #{iClassType,jdbcType=INTEGER}
	        </if>
	        dtModify=now() 
	    </set>
		WHERE 
	        id = #{id,jdbcType=INTEGER} 
	</update>

	<update id="updateInvestAmt" parameterType="java.util.Map">
        update tbsubject
        <set>
            <if test="investAmt != null">
                numActualFinancing = IFNULL(numActualFinancing,0) + #{investAmt,jdbcType=DECIMAL},
            </if>
            dtModify=now() 
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    
	<delete id="deleteById" parameterType="java.lang.Integer">
	<![CDATA[
		DELETE FROM tbsubject WHERE
        id = #{id} 
	]]>
	</delete>
    
	<select id="findById" resultMap="BaseResultMap" parameterType="java.lang.Integer">
	    SELECT <include refid="columns"/> 
	<![CDATA[
		FROM tbsubject 
		WHERE 
        id = #{id} 
	]]>
	</select>
	
	<!-- 根据标的ID，获取项目名称 -->
	<select id="findProjectNameBySubjectId" parameterType="java.lang.Integer" resultType="java.lang.String">
		select p.vcName projectName from tbproject p
		where p.id = (select s.iProjectID from tbsubject s where s.id=#{subjectId})
	</select>
	
	<!-- 根据ID查询标的 关联项目 -->
	<select id="findSubjectAsProjectBySubjectId" resultMap="BaseResultMap" parameterType="java.lang.Integer">
		select s.*,
		p.vcName projectName,p.vcCode projectCode ,p.vcType projectType,
		p.iGuaranteeID iguaranteeId,p.iBorrowerType borrowerType,p.numTotalFinancing projectNumTotalFinancing
    	from tbsubject s , tbProject p 
		where s.iProjectID=p.id and s.id=#{subjectId}
	</select>
	
	<!-- 某项目下标的的募集总额,用于添加标的时判断是否超出项目的募集金额 --> 	 	
	<select id="totalNumTotalFinancing" resultType="java.math.BigDecimal" parameterType="java.lang.Integer">
		<![CDATA[
			SELECT IFNULL(sum(numTotalFinancing),0)
			FROM tbsubject WHERE iState !=4 AND iProjectID = #{iProjectID} 
		]]>
	</select>
	
	<!-- 首页及标的列表 含排序规则 -->
	<select id="findSubjectListInStateCount" resultType="com.tzg.entitys.subject.SubjectCountVO" parameterType="java.util.Map">
    	select count(*) count,
			 IFNULL(SUM(CASE WHEN iState=10 THEN 1 ELSE 0 END),0) waitingCount,
	         IFNULL(SUM(CASE WHEN iState=11 THEN 1 ELSE 0 END),0) investingCount,
	         IFNULL(SUM(CASE WHEN iState in (12,14) THEN 1 ELSE 0 END),0) repayCount,
	         IFNULL(SUM(CASE WHEN iState=13 THEN 1 ELSE 0 END),0) overCount
    	from tbsubject s 
		where 1=1
		<if test="istate != null and istate.trim() != ''">
			and s.iState in (${istate})
		</if>
		<if test="itype != null and itype.trim() != ''">
			and s.iType in (${itype})
		</if>
		<if test="numPeriodBegin != null and numPeriodBegin.trim() != ''">
			and s.numPeriod >= #{numPeriodBegin}
		</if>
		<if test="numPeriodEnd != null and numPeriodEnd.trim() != ''">
			and s.numPeriod &lt;= #{numPeriodEnd}
		</if>
		<if test="rateBegin != null and rateBegin.trim() != ''">
			and s.numInterestRate+s.numRewardRate >= #{rateBegin}
		</if>
		<if test="rateEnd != null and rateEnd.trim() != ''">
			and s.numInterestRate+s.numRewardRate &lt;= #{rateEnd}
		</if>
		<if test="dtTrailer != null and dtTrailer.trim() != ''">
			and date_format(s.dtTrailer,'%Y-%m-%d') = #{dtTrailer}
		</if>
		<if test="dtActualCollectEnd != null and dtActualCollectEnd.trim() != ''">
			and date_format(s.dtActualCollectEnd,'%Y-%m-%d') = #{dtActualCollectEnd}
		</if>
		<if test="dtCollectStartBegin != null and dtCollectStartBegin.trim() != ''">
			and dtCollectStart >= #{dtCollectStartBegin}
		</if>
		<if test="dtCollectStartEnd != null and dtCollectStartEnd.trim() != ''">
			and dtCollectStart &lt;= #{dtCollectStartEnd}
		</if>
	</select>
	<!-- 首页及标的列表 含排序规则 -->
	<select id="findSubjectListInState" resultMap="BaseResultMap" parameterType="java.util.Map">
		select  s.*,p.vcName projectName,p.vcCode projectCode,p.vcType projectType
		from tbsubject s , tbProject p 
		where s.iProjectID=p.id 
		<if test="istate != null and istate.trim() != ''">
			and s.iState in (${istate})
		</if>
		<if test="itype != null and itype.trim() != ''">
			and s.iType in (${itype})
		</if>
		<if test="numPeriodBegin != null and numPeriodBegin.trim() != ''">
			and s.numPeriod >= #{numPeriodBegin}
		</if>
		<if test="numPeriodEnd != null and numPeriodEnd.trim() != ''">
			and s.numPeriod &lt;= #{numPeriodEnd}
		</if>
		<if test="rateBegin != null and rateBegin.trim() != ''">
			and s.numInterestRate+s.numRewardRate >= #{rateBegin}
		</if>
		<if test="rateEnd != null and rateEnd.trim() != ''">
			and s.numInterestRate+s.numRewardRate &lt;= #{rateEnd}
		</if>
		<if test="dtTrailer != null and dtTrailer.trim() != ''">
			and date_format(s.dtTrailer,'%Y-%m-%d') = #{dtTrailer}
		</if>
		<if test="dtActualCollectEnd != null and dtActualCollectEnd.trim() != ''">
			and date_format(s.dtActualCollectEnd,'%Y-%m-%d') = #{dtActualCollectEnd}
		</if>
	    <if test="dtCollectStartBegin != null and dtCollectStartBegin.trim() != ''">
			and dtCollectStart >= #{dtCollectStartBegin}
		</if>
		<if test="dtCollectStartEnd != null and dtCollectStartEnd.trim() != ''">
			and dtCollectStart &lt;= #{dtCollectStartEnd}
		</if>
	    ORDER BY 
		
	    FIELD(s.iState,11,10,12,14,13),
	    (case when s.iState in (10,11) then FIELD(s.iType,5,6,2,4,3,1) end),
		(case s.iState
		when 10 then s.dtCollectStart
		when 11 then s.dtCollectEnd end) asc,
		(case s.iState
		when 12 then s.dtActualCollectEnd
		when 14 then s.dtActualCollectEnd
		when 13 then s.dtRepayment end) desc 
				
       <![CDATA[ LIMIT ${startRecord},${endRecord} ]]>
	</select>
	 
	<select id="findPageCount" resultType="java.lang.Integer" parameterType="java.util.Map">
    	select count(*) from tbsubject where 1=1
		<include refid="queryWhere"/>
	</select>
    
	<select id="findPage" resultMap="BaseResultMap" parameterType="java.util.Map">
		select <include refid="columns"/>  from tbsubject where 1=1
		<include refid="queryWhere"/> 
		<if test="iIsAutoOpenSubject==null">
			ORDER BY id DESC 
		</if>
		<if test="iIsAutoOpenSubject!=null and iIsAutoOpenSubject.toString()=='0'">
	    	ORDER BY id DESC 
	    </if>
	    <if test="iIsAutoOpenSubject!=null and iIsAutoOpenSubject.toString()=='1'">
	    	ORDER BY iState ASC 
	    </if>
        <![CDATA[ LIMIT ${startRecord},${endRecord} ]]>
	</select>
	
	<sql id="queryWhere">
		<if test="id != null and id.trim() != ''">
		and id = #{id}
		</if>
		<if test="iprojectId != null and iprojectId.trim() != ''">
		and iProjectID = #{iprojectId}
		</if>
		<if test="vcName != null and vcName.trim() != ''">
		and vcName like "%"#{vcName}"%"
		</if>
		<if test="iloginAccountId != null and iloginAccountId.trim() != ''">
		and iLoginAccountID = #{iloginAccountId}
		</if>		
		<if test="numTotalFinancing != null and numTotalFinancing.trim() != ''">
		and numTotalFinancing = #{numTotalFinancing}
		</if>
		<if test="ivalueDateType != null and ivalueDateType.trim() != ''">
		and iValueDateType = #{ivalueDateType}
		</if>		
		<if test="numPeriod != null and numPeriod.trim() != ''">
		and numPeriod = #{numPeriod}
		</if>
		<if test="dtTrailerBegin != null and dtTrailerBegin.trim() != ''">
		and dtTrailer >= #{dtTrailerBegin}
		</if>
		<if test="dtTrailerEnd != null and dtTrailerEnd.trim() != ''">
		and dtTrailer &lt;= #{dtTrailerEnd}
		</if>
		<if test="dtCollectStartBegin != null and dtCollectStartBegin.trim() != ''">
		and dtCollectStart >= #{dtCollectStartBegin}
		</if>
		<if test="dtCollectStartEnd != null and dtCollectStartEnd.trim() != ''">
		and dtCollectStart &lt;= #{dtCollectStartEnd}
		</if>
		<if test="dtCollectEndBegin != null and dtCollectEndBegin.trim() != ''">
		and dtCollectEnd >= #{dtCollectEndBegin}
		</if>
		<if test="dtCollectEndEnd != null and dtCollectEndEnd.trim() != ''">
		and dtCollectEnd &lt;= #{dtCollectEndEnd}
		</if>
		<if test="dtActualCollectEndBegin != null and dtActualCollectEndBegin.trim() != ''">
		and dtActualCollectEnd >= #{dtActualCollectEndBegin}
		</if>
		<if test="dtActualCollectEndEnd != null and dtActualCollectEndEnd.trim() != ''">
		and dtActualCollectEnd &lt;= #{dtActualCollectEndEnd}
		</if>
		<if test="istate != null and istate.trim() != ''">
		and iState = #{istate}
		</if>
		<if test="dtRepaymentBegin != null and dtRepaymentBegin.trim() != ''">
		and dtRepayment >= #{dtRepaymentBegin}
		</if>
		<if test="dtRepaymentEnd != null and dtRepaymentEnd.trim() != ''">
		and dtRepayment &lt;= #{dtRepaymentEnd}
		</if>
		<if test="icontractId != null and icontractId.trim() != ''">
		and iContractID = #{icontractId}
		</if>
		<if test="dtCreateBegin != null and dtCreateBegin.trim() != ''">
		and dtCreate >= #{dtCreateBegin}
		</if>
		<if test="dtCreateEnd != null and dtCreateEnd.trim() != ''">
		and dtCreate &lt;= #{dtCreateEnd}
		</if>
		<if test="vcCurrentFlow != null and vcCurrentFlow.trim() != ''">
		and vcCurrentFlow = #{vcCurrentFlow}
		</if>
		<if test="vcApprovalFlow != null and vcApprovalFlow.trim() != ''">
		and vcApprovalFlow = #{vcApprovalFlow}
		</if>
		<if test="imode != null and imode.trim() != ''">
		and iMode = #{imode}
		</if>
		<if test="irepayMode != null and irepayMode.trim() != ''">
		and iRepayMode = #{irepayMode}
		</if>
		<if test="itype != null and itype.trim() != ''">
		and iType = #{itype}
		</if>
		<if test="numDiscount != null and numDiscount != ''">
		and numDiscount = #{numDiscount}
		</if>
		<if test="vcAwardsDesp != null and vcAwardsDesp.trim() != ''">
		and vcAwardsDesp = #{vcAwardsDesp}
		</if>
		<if test="numWithdrawFee != null and numWithdrawFee.trim() != ''">
	     and numWithdrawFee = #{numWithdrawFee}
	    </if>
	    <!-- linjie -->
	    <if test="iIsAutoOpenSubject != null and iIsAutoOpenSubject.trim() != ''">
	     and iIsAutoOpenSubject = #{iIsAutoOpenSubject}
	    </if>
	    <if test="iSubjectPeriodGradeID != null and iSubjectPeriodGradeID.trim() != ''">
	     and iSubjectPeriodGradeID = #{iSubjectPeriodGradeID} 
	    </if>
	    <if test="iAutoOpenDay != null and iAutoOpenDay.trim() != ''">
	     and iAutoOpenDay = #{iAutoOpenDay} 
	    </if>
	    <if test="iInterestConfigId != null and iInterestConfigId.trim() !=''">
	    and iInterestConfigID =#{iInterestConfigId}
	    </if>
	    <if test="iUseInterestTicket != null and iUseInterestTicket.trim() !=''">
	    and iUseInterestTicket =#{iUseInterestTicket}
	    </if>
	    <if test="iClassType != null and iClassType.trim() !=''">
	    and iClassType =#{iClassType}
	    </if>
	</sql>
	
	<select id="findSubjectByState" parameterType="java.lang.Integer" resultMap="BaseResultMap">
          select <include refid="columns"/>  from tbsubject where  iState = #{state,jdbcType=INTEGER}
    </select>
    
	<select id="findState5" resultMap="BaseResultMap">
          select <include refid="columns"/>  
			<![CDATA[from
			    tbsubject
			where
			    iState = 5
			        and dtTrailer <= now()
			        ]]>
    </select>    
    
	<select id="findState10" resultMap="BaseResultMap">
          select <include refid="columns"/>  
			<![CDATA[from
			    tbsubject
			where
			    iState = 10
			        and dtCollectStart <= now()
			    ]]>
    </select>     
    
	<update id="finishState11" >
			<![CDATA[
				update tbsubject 
				set 
				    iState = 14,
				    iDisplayState = 1,
					dtActualCollectEnd = dtCollectEnd
				where
				    iState = 11
				        and dtCollectEnd <= now()
			        ]]>
    </update>       
    
    <update id="updateSubjectState" parameterType="com.tzg.entitys.subject.Subject">
           UPDATE tbsubject set iState = #{istate,jdbcType=INTEGER},dtModify=now() 
			<if test="dtNextRepay != null">
	       	, dtNextRepay = #{dtNextRepay,jdbcType=DATE} 
	        </if>
			<if test="dtActualCollectEnd != null">
	       	, dtActualCollectEnd = #{dtActualCollectEnd,jdbcType=TIMESTAMP} 
	        </if>	 
			<if test="numNextRepayAmount != null">
	        ,numNextRepayAmount = #{numNextRepayAmount,jdbcType=DECIMAL} 
	        </if>	     
	        <if test="numTotalPeriod !=null">
	        ,numTotalPeriod = #{numTotalPeriod,jdbcType=INTEGER}
	        </if>		                  
           where  id = #{id,jdbcType=INTEGER}
           and iState = #{iornstate,jdbcType=INTEGER}  
    </update>
    
    <select id="querySubjectByiProjectID" parameterType="java.util.Map" resultMap="BaseResultMap">
    	select 
    	<include refid="columns"/>  
    	from tbsubject 
    	where iProjectID = #{iprojectId}
    	<if test="id != null">
    		and id != #{id}
    	</if>
    </select>
      
    <select id="querySubjectByVcName" parameterType="java.util.Map" resultMap="BaseResultMap">
    	select
    	<include refid="columns"/>
    	from tbsubject 
    	where vcName = #{vcName}
    	limit 1
    </select>
    
    <!-- app推送标的-->
	<select id="findSubjectByNumRate" resultMap="BaseResultMap" parameterType="java.util.Map">
		select  s.*,p.vcName projectName,p.vcCode projectCode,p.vcType projectType,(
        s.numInterestRate + s.numRewardRate) numRate
		from tbsubject s , tbProject p 
		where s.iProjectID=p.id 
		<if test="istate != null and istate.trim() != ''">
			and s.iState in (${istate})
		</if>
		<if test="itype != null and itype.trim() != ''">
			and s.iType in (${itype})
		</if>
		<if test="numPeriodBegin != null and numPeriodBegin.trim() != ''">
			and s.numPeriod >= #{numPeriodBegin}
		</if>
		<if test="numPeriodEnd != null and numPeriodEnd.trim() != ''">
			and s.numPeriod &lt;= #{numPeriodEnd}
		</if>
		<if test="rateBegin != null and rateBegin.trim() != ''">
			and s.numInterestRate+s.numRewardRate >= #{rateBegin}
		</if>
		<if test="rateEnd != null and rateEnd.trim() != ''">
			and s.numInterestRate+s.numRewardRate &lt;= #{rateEnd}
		</if>
		<if test="dtTrailer != null and dtTrailer.trim() != ''">
			and date_format(s.dtTrailer,'%Y-%m-%d') = #{dtTrailer}
		</if>
	    <if test="dtCollectStartBegin != null and dtCollectStartBegin.trim() != ''">
			and dtCollectStart >= #{dtCollectStartBegin}
		</if>
		<if test="dtCollectStartEnd != null and dtCollectStartEnd.trim() != ''">
			and dtCollectStart &lt;= #{dtCollectStartEnd}
		</if>
	    ORDER BY 
		
	    FIELD(s.iState,11,10,12,14,13),
	     numRate DESC,
		(case s.iState
		when 10 then s.dtCollectStart
		when 11 then s.dtCollectEnd end) asc,
		(case s.iState
		when 12 then s.dtActualCollectEnd
		when 14 then s.dtActualCollectEnd
		when 13 then s.dtRepayment end) desc 
				
       <![CDATA[ LIMIT ${startRecord},${endRecord} ]]>
	</select>
	
	<!-- 根据isubject来获取vcname -->
	<select id="findVcNameById" resultType="java.lang.String" parameterType="java.lang.Integer">
		select s.vcname from tbsubject s where s.id= #{id}
	</select>
	
	<update id="updateSubject" parameterType="com.tzg.entitys.subject.Subject">
		UPDATE tbsubject
		<set>
			<if test="iprojectId != null">
	        iProjectID = #{iprojectId,jdbcType=INTEGER} ,
	        </if>
			<if test="vcName != null">
	        vcName = #{vcName,jdbcType=VARCHAR} ,
	        </if>
	        <if test="vcShortDesp != null">
	        vcShortDesp = #{vcShortDesp,jdbcType=VARCHAR} ,
	        </if>
	        <if test="vcShortDesp == null">
	        vcShortDesp = null ,
	        </if>
			<if test="iloginAccountId != null">
	        iLoginAccountID = #{iloginAccountId,jdbcType=INTEGER} ,
	        </if>
			<if test="numInterestRate != null">
	        numInterestRate = #{numInterestRate,jdbcType=DECIMAL} ,
	        </if>
	        <if test="numRewardRate != null">
	        numRewardRate = #{numRewardRate,jdbcType=DECIMAL} ,
	        </if>
			<if test="numManagementRate != null">
	        numManagementRate = #{numManagementRate,jdbcType=DECIMAL} ,
	        </if>
			<if test="numTotalFinancing != null">
	        numTotalFinancing = #{numTotalFinancing,jdbcType=DECIMAL} ,
	        </if>
			<if test="ivalueDateType != null">
	        iValueDateType = #{ivalueDateType,jdbcType=INTEGER} ,
	        </if>
			<if test="numDelivery != null">
	        numDelivery = #{numDelivery,jdbcType=DECIMAL} ,
	        </if>
	        <if test="numDelivery == null">
	        numDelivery = null ,
	        </if>
			<if test="numMinInvest != null">
	        numMinInvest = #{numMinInvest,jdbcType=DECIMAL} ,
	        </if>
	        <if test="numMinInvest == null">
	        numMinInvest = null ,
	        </if>
			<if test="numMaxInvest != null">
	        numMaxInvest = #{numMaxInvest,jdbcType=DECIMAL} ,
	        </if>
	        <if test="numMaxInvest == null">
	        numMaxInvest = null ,
	        </if>
			<if test="numPlatFormFee != null">
	        numPlatFormFee = #{numPlatFormFee,jdbcType=DECIMAL} ,
	        </if>
			<if test="iplatFormFeeType != null">
	        iPlatFormFeeType = #{iplatFormFeeType,jdbcType=INTEGER} ,
	        </if>
			<if test="numBond != null">
	        numBond = #{numBond,jdbcType=DECIMAL} ,
	        </if>
			<if test="ibondType != null">
	        iBondType = #{ibondType,jdbcType=INTEGER} ,
	        </if>
			<if test="numPeriod != null">
	        numPeriod = #{numPeriod,jdbcType=INTEGER} ,
	        </if>
			<if test="dtTrailer != null">
	        dtTrailer = #{dtTrailer,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="dtCollectStart != null">
	        dtCollectStart = #{dtCollectStart,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="dtCollectEnd != null">
	        dtCollectEnd = #{dtCollectEnd,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="dtActualCollectEnd != null">
	        dtActualCollectEnd = #{dtActualCollectEnd,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="numActualFinancing != null">
	        numActualFinancing = #{numActualFinancing,jdbcType=DECIMAL} ,
	        </if>
			<if test="numActualExtraInterest != null">
	        numActualExtraInterest = #{numActualExtraInterest,jdbcType=DECIMAL} ,
	        </if>
			<if test="numActualInterest != null">
	        numActualInterest = #{numActualInterest,jdbcType=DECIMAL} ,
	        </if>
			<if test="istate != null">
	        iState = #{istate,jdbcType=INTEGER} ,
	        </if>
			<if test="dtRepayment != null">
	        dtRepayment = #{dtRepayment,jdbcType=DATE} ,
	        </if>
			<if test="icontractId != null">
	        iContractID = #{icontractId,jdbcType=INTEGER} ,
	        </if>
			<if test="numNextRepayAmount != null">
	        numNextRepayAmount = #{numNextRepayAmount,jdbcType=DECIMAL} ,
	        </if>
			<if test="dtNextRepay != null">
	        dtNextRepay = #{dtNextRepay,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="dtCreate != null">
	        dtCreate = #{dtCreate,jdbcType=TIMESTAMP} ,
	        </if>
			<if test="vcCurrentFlow != null">
	        vcCurrentFlow = #{vcCurrentFlow,jdbcType=VARCHAR} ,
	        </if>
			<if test="vcApprovalFlow != null">
	        vcApprovalFlow = #{vcApprovalFlow,jdbcType=VARCHAR} ,
	        </if>
			<if test="imode != null">
	        iMode = #{imode,jdbcType=INTEGER} ,
	        </if>
			<if test="irepayMode != null">
	        iRepayMode = #{irepayMode,jdbcType=INTEGER} ,
	        </if>
	        <if test="itype != null">
	        iType = #{itype,jdbcType=INTEGER} ,
	        </if>
	        <if test="idisplayState !=null">
	        iDisplayState = #{idisplayState,jdbcType=INTEGER},
	        </if>
	        <if test="numCurrentPeriod !=null">
	        numCurrentPeriod = #{numCurrentPeriod,jdbcType=INTEGER},
	        </if>	   
	        <if test="numTotalPeriod !=null">
	        numTotalPeriod = #{numTotalPeriod,jdbcType=INTEGER},
	        </if>	         
	        <if test="numDiscount != null">
	        numDiscount = #{numDiscount,jdbcType=DECIMAL} ,
	        </if> 
	        <if test="vcAwardsDesp != null">
	        vcAwardsDesp = #{vcAwardsDesp,jdbcType=VARCHAR} ,
	        </if>
	        <if test="vcAwardsDesp == null">
	        vcAwardsDesp = null ,
	        </if>
	        <if test="numWithdrawFee != null">
	        numWithdrawFee = #{numWithdrawFee,jdbcType=DECIMAL},
	        </if>
	        
	        <if test="iSubjectPeriodGradeID != null">
	        iSubjectPeriodGradeID = #{iSubjectPeriodGradeID,jdbcType=INTEGER},
	        </if>
	        <if test="iIsAutoOpenSubject != null">
	        iIsAutoOpenSubject = #{iIsAutoOpenSubject,jdbcType=INTEGER},
	        </if>
	        
	        <if test="iAutoOpenPriority != null">
	        iAutoOpenPriority = #{iAutoOpenPriority,jdbcType=INTEGER},
	        </if>
	        <if test="iAutoOpenDay != null">
	        iAutoOpenDay = #{iAutoOpenDay,jdbcType=INTEGER},
	        </if>
		<if test="iInterestConfigId != null">
	        iInterestConfigID = #{iInterestConfigId,jdbcType=INTEGER},
	        </if>
	        <if test="iUseInterestTicket != null">
	        iUseInterestTicket = #{iUseInterestTicket,jdbcType=INTEGER},
	        </if>
	        <if test="iClassType != null">
	        iClassType = #{iClassType,jdbcType=INTEGER}
	        </if>
	        dtModify=now() 
	        
	    </set>
		WHERE 
	        id = #{id,jdbcType=INTEGER} 
	</update>
	
	<!-- linjie 自动标的下架   因为要将列置为null，公共的update方法限制了传入参不能为null，所以重新写了一个 -->
	<update id="downSubject" parameterType="com.tzg.entitys.subject.Subject">
		UPDATE tbsubject
		<set>
			<if test="istate != null">
	        iState = #{istate,jdbcType=INTEGER} ,
	        </if>
	        dtTrailer=#{dtTrailer,jdbcType=TIMESTAMP} ,
	        dtCollectStart = #{dtCollectStart,jdbcType=TIMESTAMP} ,
	        dtCollectEnd = #{dtCollectEnd,jdbcType=TIMESTAMP} ,
	        dtModify=now() 
	    </set>
		WHERE 
	        id = #{id,jdbcType=INTEGER} 
	</update>
</mapper>
